openapi: 3.1.0
info:
  title: Sentinel Moderation API
  version: 0.1.0
  description: |
    Spec-first public API contract for Project Sentinel.
servers:
  - url: https://api.sentinel.example
paths:
  /health:
    get:
      summary: Health check
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    type: string
                    enum: [ok]
  /health/live:
    get:
      summary: Liveness probe
      operationId: getHealthLive
      responses:
        '200':
          description: Process is alive
          content:
            application/json:
              schema:
                type: object
                required: [status]
                properties:
                  status:
                    type: string
                    enum: [ok]
  /health/ready:
    get:
      summary: Readiness probe
      operationId: getHealthReady
      responses:
        '200':
          description: Service is ready
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthReadyResponse'
        '503':
          description: Service is degraded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthReadyResponse'
  /metrics:
    get:
      summary: Runtime metrics snapshot
      operationId: getMetrics
      responses:
        '200':
          description: Metrics counters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'
  /v1/moderate:
    post:
      summary: Moderate input text
      operationId: moderateText
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ModerationRequest'
      responses:
        '200':
          description: Moderation result
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: string
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: string
            X-RateLimit-Reset:
              description: Seconds until the current rate-limit window resets.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModerationResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: string
            X-RateLimit-Remaining:
              description: Always `0` when the request is throttled.
              schema:
                type: string
            X-RateLimit-Reset:
              description: Seconds until the current rate-limit window resets.
              schema:
                type: string
            Retry-After:
              description: Seconds the client should wait before retrying.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /v1/moderate/batch:
    post:
      summary: Moderate a batch of texts
      operationId: moderateBatch
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ModerationBatchRequest'
      responses:
        '200':
          description: Batch moderation result
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: string
            X-RateLimit-Remaining:
              description: Requests remaining in the current window.
              schema:
                type: string
            X-RateLimit-Reset:
              description: Seconds until the current rate-limit window resets.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ModerationBatchResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          headers:
            X-RateLimit-Limit:
              description: Maximum requests allowed in the current window.
              schema:
                type: string
            X-RateLimit-Remaining:
              description: Always `0` when the request is throttled.
              schema:
                type: string
            X-RateLimit-Reset:
              description: Seconds until the current rate-limit window resets.
              schema:
                type: string
            Retry-After:
              description: Seconds the client should wait before retrying.
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /v1/appeals:
    post:
      summary: Submit an appeal
      operationId: createPublicAppeal
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PublicAppealCreateRequest'
      responses:
        '201':
          description: Appeal submitted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublicAppealCreateResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key
  schemas:
    HealthReadyResponse:
      type: object
      additionalProperties: false
      required: [status, checks]
      properties:
        status:
          type: string
          enum: [ready, degraded]
        checks:
          type: object
          additionalProperties:
            type: string
            enum: [ok, empty, error]
    ModerationRequest:
      type: object
      additionalProperties: false
      required:
        - text
      properties:
        text:
          type: string
          minLength: 1
          maxLength: 5000
        context:
          $ref: '#/components/schemas/ModerationContext'
        request_id:
          type: string
          maxLength: 128
          pattern: '^[A-Za-z0-9][A-Za-z0-9._:-]{0,127}$'
    ModerationBatchItem:
      type: object
      additionalProperties: false
      required: [text]
      properties:
        text:
          type: string
          minLength: 1
          maxLength: 5000
        context:
          $ref: '#/components/schemas/ModerationContext'
        request_id:
          type: string
          maxLength: 128
          pattern: '^[A-Za-z0-9][A-Za-z0-9._:-]{0,127}$'
    ModerationBatchRequest:
      type: object
      additionalProperties: false
      required: [items]
      properties:
        items:
          type: array
          minItems: 1
          maxItems: 50
          items:
            $ref: '#/components/schemas/ModerationBatchItem'
    ModerationBatchItemResult:
      type: object
      additionalProperties: false
      required: [request_id]
      properties:
        request_id:
          type: string
          maxLength: 128
        result:
          anyOf:
            - $ref: '#/components/schemas/ModerationResponse'
            - type: 'null'
        error:
          anyOf:
            - $ref: '#/components/schemas/ErrorResponse'
            - type: 'null'
    ModerationBatchResponse:
      type: object
      additionalProperties: false
      required: [items, total, succeeded, failed]
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ModerationBatchItemResult'
        total:
          type: integer
          minimum: 0
        succeeded:
          type: integer
          minimum: 0
        failed:
          type: integer
          minimum: 0
    ModerationContext:
      type: object
      additionalProperties: false
      properties:
        source:
          type: string
          maxLength: 100
        locale:
          type: string
          maxLength: 20
        channel:
          type: string
          maxLength: 50
    PublicAppealCreateRequest:
      type: object
      additionalProperties: false
      required:
        - decision_request_id
        - original_action
        - original_reason_codes
        - original_model_version
        - original_lexicon_version
        - original_policy_version
        - original_pack_versions
      properties:
        decision_request_id:
          type: string
          minLength: 1
          maxLength: 128
        original_action:
          type: string
          enum: [ALLOW, REVIEW, BLOCK]
        original_reason_codes:
          type: array
          minItems: 1
          items:
            type: string
            pattern: '^R_[A-Z0-9_]+$'
        original_model_version:
          type: string
          minLength: 1
          maxLength: 128
        original_lexicon_version:
          type: string
          minLength: 1
          maxLength: 128
        original_policy_version:
          type: string
          minLength: 1
          maxLength: 128
        original_pack_versions:
          type: object
          minProperties: 1
          additionalProperties:
            type: string
        reason:
          type: string
          maxLength: 500
    PublicAppealCreateResponse:
      type: object
      additionalProperties: false
      required: [appeal_id, status, request_id]
      properties:
        appeal_id:
          type: integer
          minimum: 1
        status:
          type: string
          enum: [submitted]
        request_id:
          type: string
          minLength: 1
          maxLength: 128
    ModerationResponse:
      type: object
      additionalProperties: false
      required:
        - toxicity
        - labels
        - action
        - reason_codes
        - evidence
        - language_spans
        - model_version
        - lexicon_version
        - pack_versions
        - policy_version
        - latency_ms
      properties:
        toxicity:
          type: number
          minimum: 0
          maximum: 1
        labels:
          type: array
          items:
            type: string
            enum:
              - ETHNIC_CONTEMPT
              - INCITEMENT_VIOLENCE
              - HARASSMENT_THREAT
              - DOGWHISTLE_WATCH
              - DISINFO_RISK
              - BENIGN_POLITICAL_SPEECH
        action:
          type: string
          enum: [ALLOW, REVIEW, BLOCK]
        reason_codes:
          type: array
          minItems: 1
          items:
            type: string
            pattern: '^R_[A-Z0-9_]+$'
        evidence:
          type: array
          items:
            $ref: '#/components/schemas/EvidenceItem'
        language_spans:
          type: array
          items:
            $ref: '#/components/schemas/LanguageSpan'
        model_version:
          type: string
          description: |
            Identifier of the active moderation inference artifact set used for this
            decision. This value is provenance metadata and may refer to deterministic
            heuristics, learned models, or a governed combination; it is not a
            guarantee that a standalone trained model made the decision.
          example: sentinel-multi-v2
        lexicon_version:
          type: string
        pack_versions:
          type: object
          additionalProperties:
            type: string
        policy_version:
          type: string
        latency_ms:
          type: integer
          minimum: 0
    EvidenceItem:
      type: object
      additionalProperties: false
      required: [type]
      properties:
        type:
          type: string
          enum: [lexicon, vector_match, model_span]
        match:
          type: string
        severity:
          type: integer
          minimum: 1
          maximum: 3
        lang:
          type: string
        match_id:
          type: string
        similarity:
          type: number
          minimum: 0
          maximum: 1
        span:
          type: string
        confidence:
          type: number
          minimum: 0
          maximum: 1
    LanguageSpan:
      type: object
      additionalProperties: false
      required: [start, end, lang]
      properties:
        start:
          type: integer
          minimum: 0
        end:
          type: integer
          minimum: 0
        lang:
          type: string
          maxLength: 16
    ErrorResponse:
      type: object
      additionalProperties: false
      required: [error_code, message]
      properties:
        error_code:
          type: string
        message:
          type: string
        request_id:
          type: string
    MetricsResponse:
      type: object
      additionalProperties: false
      required: [action_counts, http_status_counts, latency_ms_buckets, validation_error_count]
      properties:
        action_counts:
          type: object
          additionalProperties:
            type: integer
            minimum: 0
        http_status_counts:
          type: object
          additionalProperties:
            type: integer
            minimum: 0
        latency_ms_buckets:
          type: object
          additionalProperties:
            type: integer
            minimum: 0
        validation_error_count:
          type: integer
          minimum: 0
